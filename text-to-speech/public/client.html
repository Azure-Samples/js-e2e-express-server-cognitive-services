<!DOCTYPE html>
<html lang="en">

<head>
  <title>Microsoft Cognitive Services Demo</title>
  <meta charset="utf-8" />
</head>

<body>

  <div id="content" style="display:none">
    <table width="100%">
      <tr>
        <td></td>
        <td>
          <h1 style="font-weight:500;">Microsoft Cognitive Services Speech SDK JavaScript Quickstart</h1>
        </td>
      </tr>
      <tr>
        <td align="right"><a href="https://docs.microsoft.com/azure/cognitive-services/speech-service/get-started"
            target="_blank">Resource</a>:</td>
        <td>
          <div>
            <input id="resourceKey" type="text" size="40" placeholder="Your resource key (32 characters)"
              value="">
          </div>
          <div>
            <input id="resourceRegion" type="text" size="40" placeholder="Your resource region" value="eastus"></div>
        </td>
      </tr>
      <tr>
        <td align="right" valign="top">Input Text (max 255 char)</td>
        <td><textarea id="phraseDiv" style="display: inline-block;width:500px;height:50px" maxlength="255" >all good men must come to the aid</textarea></td>
      </tr>
      <tr>
        <td></td>
        <td>
        </td>
      </tr>
      <tr>
        <td align="right" valign="top">
          Audio Result
        </td>
        <td>
          <div>
            Stream directly from Azure Cognitive Services
          </div>
          <button id="prepareSourceQueryStrings" onclick="updateSrc()">Prepare audio controls (append query string)</button>
          <button id="startSpeakTextAsyncButton">Start Text to Speech</button>

          <div id="streamByFile" >
            <div>Stream audio from file on server</div>
            <audio id="audioFile" controls preload="none" >
              <source src="http://localhost:3000/text-to-speech-file" type="audio/mpeg">
              <p>Your browser doesn't support HTML5 audio. Here is
                a <a href="myAudio.mp4">link to the audio</a> instead.</p>
            </audio>
          </div>
          <hr>
          <div id="streamByStream" >
            <div>Stream audio from buffer on server</div>
            <audio id="audioStream" controls preload="none">
              <source src="http://localhost:3000/text-to-speech-stream" type="audio/mpeg">
              <p>Your browser doesn't support HTML5 audio. Here is
                a <a href="myAudio.mp4">link to the audio</a> instead.</p>
            </audio>
          </div>
          <hr>
          <div id="warning">
            <h1 style="font-weight:500;">Speech Recognition Speech SDK not found
              (microsoft.cognitiveservices.speech.sdk.bundle.js missing).</h1>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Speech SDK reference sdk. -->
  <script
    src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js">
    </script>

  <!-- Speech SDK USAGE -->
  <script>
    // status fields and start button in UI
    var phraseDiv;
    var resultDiv;
    var startSpeakTextAsyncButton;

    // subscription key and region for speech services.
    var subscriptionKey, serviceRegion;
    var authorizationToken;
    var SpeechSDK;
    var synthesizer;

    function updateSrc(){
      
      console.log("audio control div clicked");

      const resourceKey = document.getElementById('resourceKey').value;
      const resourceRegion  = document.getElementById('resourceRegion').value;
      const phrase = encodeURIComponent(document.getElementById('phraseDiv').value)
      const queryString = `region=${resourceRegion}&key=${resourceKey}&phrase=${phrase}`; 

      const byFileSrc = `http://localhost:3000/text-to-speech-file?${queryString}`
      const byStreamSrc = `http://localhost:3000/text-to-speech-stream?${queryString}`
      
      console.log(`byFileSrc = ${byFileSrc}`)
      console.log(`byStreamSrc = ${byStreamSrc}`)
      
      // append query string to src
      var audioControlFile = document.getElementById('audioFile');
      audioControlFile.src = byFileSrc;

      // append query string to src
      var audioControlStream = document.getElementById('audioStream');
      audioControlStream.src = byStreamSrc;
      
      console.log(`audioControlStream.src = ${audioControlStream.src}`)
      console.log(`audioControlFile.src = ${audioControlFile.src}`)
       
    }
    
    document.addEventListener("DOMContentLoaded", function () {
      startSpeakTextAsyncButton = document.getElementById("startSpeakTextAsyncButton");
      subscriptionKey = document.getElementById("subscriptionKey");
      serviceRegion = document.getElementById("serviceRegion");
      phraseDiv = document.getElementById("phraseDiv");
      
      startSpeakTextAsyncButton.addEventListener("click", function () {
        startSpeakTextAsyncButton.disabled = true;
        phraseDiv.innerHTML = "";

        // if we got an authorization token, use the token. Otherwise use the provided subscription key
        var speechConfig;
        if (authorizationToken) {
          speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(authorizationToken, serviceRegion.value);
        } else {
          if (subscriptionKey.value === "" || subscriptionKey.value === "subscription") {
            alert("Please enter your Microsoft Cognitive Services Speech subscription key!");
            startSpeakTextAsyncButton.disabled = false;
            return;
          }
          speechConfig = SpeechSDK.SpeechConfig.fromSubscription(subscriptionKey.value, serviceRegion.value);
        }

        synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);

        let inputText = phraseDiv.value;
        synthesizer.speakTextAsync(
          inputText,
          function (result) {
            startSpeakTextAsyncButton.disabled = false;
            if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
              resultDiv.innerHTML += "synthesis finished for [" + inputText + "].\n";
            } else if (result.reason === SpeechSDK.ResultReason.Canceled) {
              resultDiv.innerHTML += "synthesis failed. Error detail: " + result.errorDetails + "\n";
            }
            window.console.log(result);
            synthesizer.close();
            synthesizer = undefined;
          },
          function (err) {
            startSpeakTextAsyncButton.disabled = false;
            resultDiv.innerHTML += "Error: ";
            resultDiv.innerHTML += err;
            resultDiv.innerHTML += "\n";
            window.console.log(err);

            synthesizer.close();
            synthesizer = undefined;
          });
      });

      if (!!window.SpeechSDK) {
        SpeechSDK = window.SpeechSDK;
        startSpeakTextAsyncButton.disabled = false;

        document.getElementById('content').style.display = 'block';
        document.getElementById('warning').style.display = 'none';

        // in case we have a function for getting an authorization token, call it.
        if (typeof RequestAuthorizationToken === "function") {
          RequestAuthorizationToken();
        }
      }
    });

  </script>
</body>

</html>